<script type="text/javascript">
	var question = "";
	var options=[];
	var answer = [];
	var explain = "";
	var modurl="questionServlet.do";
	$(function() {
		ui_question_init_list();
		
		$('#ui_question_dg_tb_course').combobox( {
			url : 'courseServlet.do?action=list',
			method : 'get',
			valueField : 'id',
			textField : 'name',
			panelHeight : 'auto',
			editable : false,
			icons : [ {
				iconCls : 'icon-tip'
			} ] ,
			onSelect : function(row) {				
				$('#ui_question_dg_tb_unit').combotree( {
					url : 'courseUnitServlet.do?action=list&courseId='+row.id,
					method : 'get',					
					lines:true,	
					panelHeight : 'auto',
					editable : false,
					icons : [ {
						iconCls : 'icon-tip'
					} ],
					onSelect : function(r) {							
					}
				});
			}
		});			
		$('#ui_question_dg_tb_type').combobox( {
			url : 'questionServlet.do?action=listQuestionType',
			method : 'get',
			valueField : 'typeId',
			textField : 'typeName',
			panelHeight : 'auto',
			editable : false,
			icons : [ {
				iconCls : 'icon-tip'
			} ]
		});
	});
		
	function ui_question_init_list(){
    	
        $("#ui_question_dg").datagrid({       //初始化datagrid
            url: modurl+"?action=search",
            striped: true, rownumbers: true, pagination: true, pageSize: 20,
            idField: 'id',
            sortName: 'id',
            sortOrder: 'desc',
            pageList: [20, 40, 60, 80, 100],
            frozenColumns: [[
                { field: 'ck', checkbox: true }                
            ]],
            columns: [[
				{
                    field: 'title', title: '试题题干', width: 400,
                    formatter: function (value, row, index) {     
                    	var v = $('<div>'+value+'</div>').text();
                        return value && value.length > 35 ? '<span title="' + v + '">' + v + '</span>' : v;
                    }
                }, 
                { field: 'typeName', title: '试题内型', sortable: true,width: 80},
                { field: 'difficulty', title: '难度系数', sortable: true, width: 80 },
                { field: 'courseName', title: '所属课程', sortable: true, width: 120},                
          		{ field: 'nuitName', title: '课程单元', sortable: true, width: 120 }          		
            ]],
            toolbar: '#ui_question_dg_tb'
            		/*
            toolbar: [{
                text: '添加',
                iconCls: 'icon-add',
                handler: function () { ui_question_add(); }
            }, {
                text: '修改',
                iconCls: 'icon-edit',
                handler: function () { ui_question_edit(); }
            }, {
                text: '删除',
                iconCls: 'icon-remove',
                handler: function () { ui_question_delete(); }
            }, {
                text: '审核',
                iconCls: 'icon-remove',
                handler: function () { ui_question_audit(); }
            }
            ]*/
        });       
    }
	

	
    function ui_question_init_editor(q){
		$('#ui_question_course').combobox( {
			url : 'courseServlet.do?action=list',
			method : 'get',
			valueField : 'id',
			textField : 'name',
			panelHeight : 'auto',
			editable : false,
			icons : [ {
				iconCls : 'icon-tip'
			} ],
			
			/*
			formatter : function(row) {
				var s = '<span style="font-weight:bold">' + row.name
						+ '</span><br/>';
				return s;
			},*/
			onSelect : function(row) {
				$('#ui_question_course_unit').combotree( {
					url : 'courseUnitServlet.do?action=list&courseId='+row.id,
					method : 'get',
					panelHeight : 'auto',
					editable : false,
					icons : [ {
						iconCls : 'icon-tip'
					} ],
					onLoadSuccess:function(node,data){
		        		if(q.courseunitId){
		        			$('#ui_question_course_unit').combotree('setValue',q.courseunitId);
		        		}
		        	}
				});
			}
		});
		
		$('#ui_question_questionType').combobox({
			url : 'questionServlet.do?action=listQuestionType',
			method : 'get',
			valueField : 'typeId',
			textField : 'typeName',
			panelHeight : 'auto',
			editable : false,
			icons : [ {
				iconCls : 'icon-tip'
			} ],
			/*
			formatter : function(row) {
				var s = '<span style="font-weight:bold">' + row.typeName
						+ '</span><br/>';
				return s;
			},
			*/
			onSelect : function(row) {
				ui_question_option_init(row.typeId);				
			}
		});	
	}
    
    function ui_question_add(){
		ui_question_editor("添加试题");
		
	}
    
    function ui_question_edit(){
    	var rows = $("#ui_question_dg").datagrid("getChecked");
        if (rows.length != 1) {
            $.show_warning("提示", "请选择一道要修改的试题！");
            $("#ui_question_dg").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        var question = rows[0];
        
        
		ui_question_editor("修改试题",question);
		
	}

	
	/*
	* 打开编辑器进行操作
	* title:编辑器标题
	* question:试题
	*/
    function ui_question_editor(title,question) {
		var iconcls = "icon-add";
		var action = "add";		
		if(question){
			iconcls = "icon-edit";
			action = "edit";						
		}
        $("<div/>").dialog({   
        	id: "ui_question_editor_dialog",
        	href:'questionEditor.html',
            title: title,
            iconCls:iconcls,
            height: 560,
            width: 820,
            modal: true,
            buttons: [{
                id: "ui_question_editor_save_btn",
                text: '保存试题',
                iconCls: "icon-save",
                handler: function () {      
                	var questionId = $('#hiddenQuestionId').val();
                	var content = UE.getEditor('ui_exam_editor').getContent();                	
                	saveCurrent2();
                	
                	var cid = $('#ui_question_course').combobox("getValue");
                	if(!cid){
                		$.show_alert("提示", "课程不能为空！");
                		return;
                	}
                	
                	var cunid = $('#ui_question_course_unit').combobox("getValue");
                	var difficulty = $('#ui_question_difficulty').slider("getValue");
                	
                	var question = $('#hiddenQuestion').val();
                	if(question.length==0 || $("<div>"+question+"</div>").text().length==0){
                		 $.show_alert("提示", "题干不能为空！");
                		return;
                	}
                	
                	var explain = $('#hiddenExplain').val();                	                
                	var len = $('[name=hiddenOption]').length;
                	var options = [];
                	var answer = [];
                	var optype = $('#ui_question_questionType').combobox("getValue");
                	if(optype==1 || optype==2 || optype==3){
                		var str="A";
            			var code = str.charCodeAt();            			
	                	for(var i=1;i<=len;i++){
	                		var n = String.fromCharCode(code+i-1); 
	                		var opt = $('#hiddenOption'+i).val();
	                		if(opt.length==0 || $("<div>"+opt+"</div>").text().length==0){
		                   		 $.show_alert("提示", "选项"+ n +"不能为空！");
		                   		return;
		                   	}
	                		if(questionId>0){
	                			var oid = $('#hiddenOption'+i).attr('oid');
	                			opt = oid+'|'+ opt;
	                		}
	                		options.push(opt);
	                	}
	                	
	                	$('[name=ui_question_answer]:checked').each(function(){
	                		var v= $(this).attr('value');
	                		answer.push(v);
	                	});
	                	
	                	if(answer.length==0){
	                		 $.show_alert("提示", "答案不能为空！");
		                 	 return;
	                	}
	                	
                	}
                	if(optype>=5){
                		var ans = $('#hiddenAnswer').val();
                		answer.push(ans);
                	}
                	                	
                	para = {};
                    para.action = action;
                    para.timespan = new Date().getTime();
                    
                    if(questionId>0) para.id=questionId;
                    
                    para.title = question;
                    //以制表符分隔
                    var t = String.fromCharCode(9);
                    
                    para.options = options.join(t);
					para.answer = answer.join(',');
					para.explain = explain;
					para.courseId = cid;
					para.courseunitId = cunid;
					para.typeId = optype;
					para.difficulty = difficulty;
                   
                    $.ajax({
                        url: modurl,
                        data: para,
                        type: "POST",
                        dataType: "json",
                        success: function (data) {
                            if (data.success) {
                                $.show_warning("提示", data.msg);
                                $("#ui_question_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                                if(questionId>0){
                                	$("#ui_question_editor_dialog").dialog('destroy');
                            		UE.getEditor('ui_exam_editor').destroy(); 
                                }
                            } else {
                                $.show_warning("提示", data.msg);
                            }
                        }
                    });
                	
                }
            },{
                id: "ui_question_editor_view_btn",
                text: '预览试题',
                iconCls: "icon-search",
                handler: function () {         
                	saveCurrent();
                	var question = $('#hiddenQuestion').val();                	
                	$('#view_question_content').html("<span style='float:left;color:blue'>题干：</span><div>"+question+"</div>");
                	
                	var explain = $('#hiddenExplain').val();
                	$('#view_question_explain').html("<span style='float:left;color:pink'>答案解析：</span><div>"+explain+"</div>");
                	
                	var len = $('[name=hiddenOption]').length;
                	var options = "";
                	for(var i=1;i<=len;i++){  
                		var str="A";
            			var code = str.charCodeAt();
            			var n = String.fromCharCode(code+i-1);                		
                		var opt = $('#hiddenOption'+i).val();
                		options += "<div style='padding-top:5px'><span style='float:left;color:green'>"+n+". </span>"+opt + "</div>";                		
                	}
                	$('#view_question_option').html(options);
                	var answer = [];
                	$('[name=ui_question_answer]:checked').each(function(){
                		var v= $(this).attr('value');
                		answer.push(v);
                	});
                	$('#view_question_answer').html("<span style='float:left;color:red'>参考答案：</span><div>"+answer.join(',')+"</div>");
                	uParse('#question_view_div', { rootPath: 'ueditor/'});
                	$('#question_view_div').dialog({
                		title: '试题预览',
                        iconCls:"icon-search",
                        height: 400,
                        width: 600,
                        modal: true
                	});
                	
                }
            }],
            onLoad: function () {  
            	
            	ui_question_init_editor(question);
            	var ue = UE.getEditor('ui_exam_editor');  
            	$('#ui_question_course_unit').combobox({});
            	
            	$('#hiddenQuestionId').val(question.id);
            	$('#btn_question_question').linkbutton({iconCls:"icon-edit"});    
            	$('#ui_question_questionType').combobox('setValue',1);
            	if(question){
            		$('#ui_question_course').combobox('setValue',question.courseId);
            		$('#ui_question_questionType').combobox('setValue',question.typeId);
            		
            		$('#ui_question_difficulty').slider("setValue",question.difficulty);
            		$('#hiddenExplain').val(question.explain);
            		$('#hiddenQuestion').val(question.title);
            		ui_question_option_init(question.typeId,question);
	            	ue.addListener("ready", function () {                    
	                    ue.setContent(question.title);	                    
	                    
	          		});	            	
            	}
            	
            },
            onClose: function () {
            	$("#ui_question_editor_dialog").dialog('destroy');
            	UE.getEditor('ui_exam_editor').destroy();                   	
            }
        });
    }
	
	function ui_question_delete(){
		var rows = $("#ui_question_dg").datagrid("getChecked");
        if (rows.length < 1) {
            $.show_warning("提示", "请先勾选要删除的试题");
            return;
        }
        $.messager.confirm('提示', '确定删除勾选的这' + rows.length + '道试题吗？', function (r) {
            if (r) {
                para = {};
                para.action = "delete";
                para.timespan = new Date().getTime();

                var ids = [];
                $.each(rows, function (i, row) {
                    ids.push(row.id);
                });
                para.ids = ids.join(",");
                $.ajax({
                    url: modurl,
                    data: para,
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        if (data.success) {
                            $.show_warning("提示", "删除成功！");
                            $("#ui_question_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                        } else {
                            $.show_warning("提示", data.msg);
                        }
                    }
                });
            }
        });
	}
	
	/*
		导入试题	
	*/
	
	function ui_question_import() {
		var modname="ui_question";
		$('<div/>').dialog({
			id : modname + "_common_dialog",
			href : 'upload.html',
			title : '试题导入',
			iconCls : 'icon-import',
			height : 220,
			width : 380,
			modal : true,
			buttons : [ {
				id : modname + "_common_btn",
				iconCls : 'icon-cancel',
				text : '关闭',
				handler : function() {
					$("#ui_question_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');					
					$("#" + modname + "_common_dialog").dialog('destroy');  
				}
			} ],
			onLoad : function() {				
				$('#ui_upload_file_template').attr('href','tpl/试题模板.xls');	
				$('#ui_upload_importurl').val('questionServlet.do');				
			},
			onClose : function() {
				$("#" + modname + "_common_dialog").dialog('destroy'); //销毁dialog对象
			}
		});
	}

	function ui_question_export() {		
		
		$('<div/>').dialog({			
			id : "ui_question_common_dialog",
			href : 'export.html',
			title : '试题导出',
			iconCls : 'icon-export',
			height : 150,
			width : 320,
			modal : true,
			buttons : [ {				
				iconCls : 'icon-cancel',
				text : '关闭',
				handler : function() {
					$("#ui_question_common_dialog").dialog('destroy'); //销毁dialog对象	
				}
			} ],
			onLoad : function() {	
				$('#ui_export_hitting').text('正在导出文件，请稍候...');
				$('#ui_export_download').hide();
				var para = {};
				para.action='export';
				para.where = getWhere();
				$.ajax({
					url:'questionServlet.do',
					method:'POST',
					dataType:'json',
					data:para,
					success:function(data){
						if(data.success){
							$('#ui_export_hitting').text('导出结束，请点击文件下载！');
							$('#ui_export_url').attr("href","downloadServlet.do?action=download&filename="+data.msg);
							$('#ui_export_url').text(data.msg);
							$('#ui_export_download').show();
							
						}else{
							$.show_warning("提示",data.msg);
						}
					}
				});	
			},
			onClose : function() {
				$("#ui_question_common_dialog").dialog('destroy'); //销毁dialog对象
			}
		});			
	}

	function getWhere(){
		var where = "1=1";
		var cid = $('#ui_question_dg_tb_course').combobox("getValue");
		var uid = $('#ui_question_dg_tb_unit').combobox("getValue");
		var tid = $('#ui_question_dg_tb_type').combobox("getValue");
		var title = $('#ui_question_dg_tb_title').textbox("getValue");
		if (cid)
			where += ' AND courseId=' + cid;
		if (uid)
			where += ' AND courseunitId=' + uid;
		if (tid)
			where += ' AND typeId=' + tid;

		if (title && title.length > 0)
			where += " AND title like '%" + title + "%'";
		return where;
	}
	function ui_question_search() {
		var where = getWhere();
		$("#ui_question_dg").datagrid("load", {
			where : where
		}).datagrid('clearSelections').datagrid('clearChecked');
		;
	}
</script>
<div id="ui_layout" class="easyui-layout"
	data-options="fit:true,border:false">
	<div data-options="region:'center',border:false">
		<table id="ui_question_dg" data-options="fit:true,border:false">
        </table>
        <div id="ui_question_dg_tb">
        	<div>
        	<a href="#" class="easyui-linkbutton" plain="true" data-options="iconCls:'icon-add'," onclick="ui_question_add()" >添加</a>
        	<a href="#" class="easyui-linkbutton" plain="true" data-options="iconCls:'icon-edit'" onclick="ui_question_edit()" >修改</a>
        	<a href="#" class="easyui-linkbutton" plain="true" data-options="iconCls:'icon-remove'" onclick="ui_question_delete()" >删除</a>
        	<a href="#" class="easyui-linkbutton" plain="true"  >|</a>
        	<a href="#" class="easyui-linkbutton" plain="true" data-options="iconCls:'icon-import'" onclick="ui_question_import()" >导入</a>
        	<a href="#" class="easyui-linkbutton" plain="true" data-options="iconCls:'icon-export'" onclick="ui_question_export()" >导出</a>
        	
        	</div>
        	<div>
			课程: 
			<input id="ui_question_dg_tb_course" />
			单元:
			<input id="ui_question_dg_tb_unit" class="easyui-combobox"  />
			<img style="cursor: pointer; vertical-align: middle;" onclick="$('#ui_question_dg_tb_unit').combotree('clear');"
                        alt="清空单元" title="清空单元" src="easyui/themes/icons/edit-clear.png" />
			题型:
			<input id="ui_question_dg_tb_type" />
			试题内容:
			<input class="easyui-textbox"  id="ui_question_dg_tb_title" />
			<a href="#" class="easyui-linkbutton" onclick="ui_question_search()" iconCls="icon-search">查询</a>
        	</div>
        </div>
	</div>
	<div id="question_view_div" style="padding:20px">
		<div id="view_question_content" style="padding-top:10px;clear:both"></div>
		<div id="view_question_option" style="padding-top:10px;clear:both"></div>
		<div id="view_question_answer" style="padding-top:10px;clear:both"></div>
		<div id="view_question_explain" style="padding-top:10px;clear:both"></div>
	</div>
	
	
</div>