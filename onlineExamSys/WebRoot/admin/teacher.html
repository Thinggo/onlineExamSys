<script type="text/javascript">
	var modurl = "teacherServlet.do"
    $(function () {
    	ui_teacher_init_list();
        //回车搜索
        /*
        $("#ui_teacher_search").find('input').on('keyup', function (event) {
            if (event.keyCode == '13') {
                ui_teacher_searchdata();
            }
        })*/
    });

    function ui_teacher_init_list(toolbar) {
        $("#ui_teacher_dg").datagrid({       //初始化datagrid
            url: modurl+"?action=search",
            striped: true, rownumbers: true, pagination: true, pageSize: 20,
            idField: 'id',
            sortName: 'regTime',
            sortOrder: 'desc',
            pageList: [20, 40, 60, 80, 100],
            frozenColumns: [[
                             { field: 'ck', checkbox: true },
                             { width: 100, title: '工号', field: 'no', sortable: true }
                             ]],
            columns: [[
					   { field: 'name',  title: '姓名',width: 80, sortable: true },
					   { field: 'phone',  title: '电话',width: 80, sortable: true },
                       { field: 'roleId', title: '角色', width: 180, sortable: true },
                       { field: 'deptId', title: '部门', width: 150, sortable: true},
                       { field: 'status', title: '状态', width: 150, sortable: true,
                           formatter: function (value, row, index) {
                               return value && value.length > 15 ? '<span title="' + value + '">' + value + '</span>' : value;
                           }
                       },
                       { field: 'regTime', title: '注册时间', sortable: true, width: 130 },
                       { field: 'loginTime', title: '登录时间', sortable: true, width: 130 },
                       { field: 'loginIp', title: '登录IP', sortable: true, width: 130 }
            	]],
            //toolbar: toolbar.length == 0 ? null : toolbar,
            toolbar: [{
                text: '添加',
                iconCls: 'icon-add',
                handler: function () { ui_teacher_add(); }
            }, {
                text: '修改',
                iconCls: 'icon-edit',
                handler: function () { ui_teacher_edit(); }
            }, {
                text: '删除',
                iconCls: 'icon-remove',
                handler: function () { ui_teacher_delete() }
            }, '-', {
                text: '部门设置',
                iconCls: 'icon-group',
                handler: function () { ui_teacher_setdept() }
            }, {
                text: '角色设置',
                iconCls: 'icon-key',
                handler: function () { ui_teacher_setrole() }
            }],

            onDblClickRow: function (rowIndex, rowData) {     //双击行弹框编辑
                //被编辑列高亮，其他列去除高亮
                $("#ui_teacher_dg").datagrid('clearSelections').datagrid('clearChecked').datagrid('checkRow', rowIndex);
                ui_teacher_edit();
            }
        });
    }

    //添加用户
    function ui_teacher_add() {
        $("<div/>").dialog({
            id: "ui_teacher_add_dialog",
            href: "teacherEdit.html",
            title: "添加用户",
            iconCls: 'icon-add',
            height: 350,
            width: 460,
            modal: true,
            buttons: [{
                id: "ui_teacher_add_btn",
                iconCls: 'icon-add',
                text: '添 加',
                handler: function () {
                    $("#ui_teacher_editform").form("submit", {
                        url: modurl,
                        onSubmit: function (param) {
                            $('#ui_teacher_add_btn').linkbutton('disable');    //点击就禁用按钮，防止连击
                            param.action = 'add';
                            if ($(this).form('validate'))
                                return true;
                            else {
                                $('#ui_teacher_add_btn').linkbutton('enable');   //恢复按钮
                                return false;
                            }
                        },
                        success: function (data) {
                            var dataJson = eval('(' + data + ')');    //转成json格式
                            if (dataJson.success) {
                                $("#ui_teacher_add_dialog").dialog('destroy');  //销毁dialog对象
                                $.show_warning("提示", "添加成功！");
                                $("#ui_teacher_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                            } else {
                                $('#ui_teacher_add_btn').linkbutton('enable');   //恢复按钮
                                $.show_warning("提示", dataJson.msg);
                            }
                        }
                    });
                }
            }],
            onLoad: function () {
                $("#ui_teacher_userid_add").focus();
            },
            onClose: function () {
                $("#ui_teacher_add_dialog").dialog('destroy');  //销毁dialog对象
            }
        });
    }
    //修改用户
    function ui_teacher_edit() {
        var rows = $("#ui_teacher_dg").datagrid("getChecked");
        if (rows.length < 1) {
            $.show_warning("提示", "请先勾选要修改的用户或者双击某个用户");
            return;
        }
        if (rows.length > 1) {
            $.show_warning("提示", "不支持批量修改");
            $("#ui_teacher_dg").datagrid('clearSelections').datagrid('clearChecked');
            return;
        }
        var row = rows[0];
        $("<div/>").dialog({
            id: "ui_teacher_edit_dialog",
            href: "html/teacherEdit.html",
            title: "修改用户",
            iconCls: 'icon-edit',
            height: 350,
            width: 460,
            modal: true,
            buttons: [{
                id: "ui_teacher_edit_btn",
                iconCls: 'icon-edit',
                text: '修 改',
                handler: function () {
                    $("#ui_teacher_editform").form("submit", {
                        url:modeurl,
                        onSubmit: function (param) {
                            $('#ui_teacher_edit_btn').linkbutton('disable');   //点击就禁用按钮，防止连击
                            param.action = 'edit';
                            if ($(this).form('validate'))
                                return true;
                            else {
                                $('#ui_teacher_edit_btn').linkbutton('enable');   //恢复按钮
                                return false;
                            }
                        },
                        success: function (data) {
                            var dataJson = eval('(' + data + ')');    //转成json格式
                            if (dataJson.success) {
                                $("#ui_teacher_edit_dialog").dialog('destroy');  //销毁dialog对象
                                $.show_warning("提示", "修改成功！");
                                $("#ui_teacher_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                            } else {
                                $('#ui_teacher_edit_btn').linkbutton('enable');    //恢复按钮
                                $.show_warning("提示", dataJson.msg);
                            }
                        }
                    });
                }
            }],
            onLoad: function () {
                $("#ui_teacher_id_edit").val(row.id);
                $("#ui_teacher_username_edit").textbox("setValue", row.userName);
                $("#ui_teacher_realname_edit").textbox("setValue", row.realName);
                $("#ui_teacher_points_edit").numberbox("setValue", row.points);
                $("#ui_teacher_tel_edit").textbox("setValue", row.tel);
                if (row.status) {
                    $("#ui_teacher_status_edit").attr("checked", "checked");
                }
                $("#ui_teacher_description_edit").val(row.description);
            },
            onClose: function () {
                $("#ui_teacher_edit_dialog").dialog('destroy');  //销毁dialog对象
            }
        });
    }
    //删除用户（可批量）
    function ui_teacher_delete() {
        var rows = $("#ui_teacher_dg").datagrid("getChecked");
        if (rows.length < 1) {
            $.show_warning("提示", "请先勾选要删除的用户");
            return;
        }
        $.messager.confirm('提示', '确定删除勾选的这' + rows.length + '个用户？', function (r) {
            if (r) {
                para = {};
                para.action = "delete";
                para.timespan = new Date().getTime();

                var ids = [];
                $.each(rows, function (i, row) {
                    ids.push(row.id);
                });
                para.ids = ids.join(",");
                $.ajax({
                    url: modurl,
                    data: para,
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        if (data.success) {
                            $.show_warning("提示", "删除成功！");
                            $("#ui_teacher_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                        } else {
                            $.show_warning("提示", data.msg);
                        }
                    }
                });
            }
        });
    }
    
    //角色设置（可批量）
    function ui_teacher_setrole() {
        var rows = $("#ui_teacher_dg").datagrid("getChecked");
        if (rows.length < 1) {
            $.show_warning("提示", "请先勾选要设置角色的用户");
            return;
        }
        var row = rows[0];
        $("<div/>").dialog({
            id: "ui_teacher_setrole_dialog",
            href: "html/teacherSetRole.html",
            title: rows.length == 1 ? "设置角色" : "批量设置角色：" + rows.length + "个用户",
            iconCls: "icon-key_go",
            height: 220,
            width: 380,
            modal: true,
            buttons: [{
                id: "ui_teacher_setrole_btn",
                text: '确 定',
                handler: function () {
                    $("#ui_teacher_setroleform").form("submit", {
                        url: modurl,
                        onSubmit: function (param) {
                            $('#ui_teacher_setrole_btn').linkbutton('disable');    //点击就禁用按钮，防止连击
                            param.action = 'setrole';
                        },
                        success: function (data) {
                            var dataJson = JSON.parse(data);    //转成json格式
                            if (dataJson.success) {
                                $("#ui_teacher_setrole_dialog").dialog('destroy');  //销毁dialog对象
                                $.show_warning("提示", "角色设置成功！");
                                $("#ui_teacher_dg").datagrid("reload").datagrid('clearSelections').datagrid('clearChecked');
                            } else {
                                $('#ui_teacher_setrole_btn').linkbutton('enable');   //恢复按钮
                                $.show_warning("提示", dataJson.msg);
                            }
                        }
                    });
                }
            }],
            onLoad: function () {
                if (rows.length == 1) {   //如果是设置一个用户就自动勾选已经有的角色
                    $('#ui_teacher_setrole_role').combobox('setValues', row.roleIds);
                    $("#ui_teacher_setrole_userid").val(row.id);
                    $("#ui_teacher_setrole_username").val(row.userName);
                }
                else {
                    var userids = "";
                    var usernames = "";
                    for (var i = 0; i < rows.length; i++) {
                        userids += rows[i].id + ",";
                        usernames += rows[i].userName + ",";
                    }
                    $("#ui_teacher_setrole_userid").val(userids.substring(0, userids.length - 1));
                    $("#ui_teacher_setrole_username").val(usernames.substring(0, usernames.length - 1));
                }
            },
            onClose: function () {
                $("#ui_teacher_setrole_dialog").dialog('destroy');  //销毁dialog对象
            }
        });
    }
    function ui_teacher_searchdata() {
        var whereStr = "1=1";
        var no = $('#ui_teacher_search').find('[name=ui_teacher_no]').val();
        var rname =  $('#ui_teacher_search').find('[name=ui_teacher_name]').val();        
        var stime = $('#ui_teacher_regtime_start').datebox('getValue');
        var etime = $('#ui_teacher_regtime_end').datebox('getValue');
        if (no != "") {
            whereStr += " and no='" + no + "'";
        }
        if (name != "") {
            whereStr += " and name='" + name + "'";
        }        
        if (stime != "") {
            whereStr += " and regTime > '" + stime + "'";
        }
        if (etime != "") {
            whereStr += " and regTime < '" + etime + "'";
        }
        $("#ui_teacher_dg").datagrid('load', {where:whereStr});
        $("#ui_teacher_dg").datagrid('clearSelections').datagrid('clearChecked');
        //$('#ui_teacher_layout').layout('collapse', 'east');    //隐藏
    }
    function ui_teacher_cleardata() {
        $('#ui_teacher_search input').val('');
        $('#ui_teacher_search select').val('select');
        $('#ui_teacher_regtime_start').datebox('setValue', '');
        $('#ui_teacher_regtime_end').datebox('setValue', '');
        $("#ui_teacher_dg").datagrid('load', {});

        $("#ui_teacher_dg").datagrid('clearSelections').datagrid('clearChecked');
        //$('#ui_teacher_layout').layout('collapse', 'east');    //隐藏
    }
</script>
<div id="ui_teacher_layout" class="easyui-layout" data-options="fit:true,border:false">
    <div data-options="region:'west',split:true,border:true,collapsed:true" title="多条件查询"
        style="width: 280px;">
        <div id="ui_teacher_search">
            <table class="tableForm" style="width: 100%; height: 100%; background: #F5F5F5;">
                <tr>
                    <th>工号：
                    </th>
                    <td>
                        <input name="ui_teacher_no" class="easyui-textbox"  autocomplete="off" style="width: 130px;" />
                    </td>
                </tr>
                <tr>
                    <th>姓名：
                    </th>
                    <td>
                        <input name="ui_teacher_name" class="easyui-textbox"  autocomplete="off" style="width: 130px;" />
                    </td>
                </tr>                                
                <tr>
                    <th>注册时间：
                    </th>
                    <td>
                        <input name="ui_teacher_regtime_start" id="ui_teacher_regtime_start" class="easyui-datebox"
                            editable="false" style="width: 140px;" />
                    </td>
                </tr>
                <tr>
                    <th>至：
                    </th>
                    <td>
                        <input name="ui_teacher_regtime_end" id="ui_teacher_regtime_end" class="easyui-datebox"
                            editable="false" style="width: 140px;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <a href="javascript:void(0);" class="easyui-linkbutton" iconcls="icon-search" plain="true"
                            onclick="ui_teacher_searchdata();">搜索</a>
                    </td>
                    <td>
                        <a href="javascript:void(0);" class="easyui-linkbutton" iconcls="icon-clear" plain="true"
                            onclick="ui_teacher_cleardata();">清空条件</a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div data-options="region:'center',border:false">
        <table id="ui_teacher_dg" data-options="fit:true,border:false">
        </table>
    </div>
</div>
